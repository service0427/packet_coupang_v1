# Rate Limit 분석 리포트 (2025-11-26)

## 요약

쿠팡 Akamai의 Rate Limit 패턴을 분석한 결과, **일별 Rate Limit 리셋**과 **버스트 차단**의 두 가지 메커니즘이 확인됨.

## 테스트 결과

### 시간대별 차단율 비교

| 시간 | IP당 동시요청 | 차단율 | 발견율 | 비고 |
|------|--------------|--------|--------|------|
| 23:36 | 2 | 47% | 35% | - |
| 23:49 | 5 | 22% | 59% | - |
| 23:50 | 10 | 73% | 25% | 버스트 차단 증가 |
| 23:57 | 20 | 71% | 16% | 버스트 차단 심함 |
| **00:06** | 3 | **0%** | **70%** | 자정 리셋 직후 |
| **00:13** | 3 | **0%** | **89%** | 자정 리셋 효과 지속 |

### 핵심 발견

#### 1. 일별 Rate Limit 리셋 (자정 00:00)

```
23:57 - 39.7.47.*: 100% 차단 (39회 전부 차단)
00:13 - 39.7.47.*: 0% 차단, 100% 발견 (8회 전부 성공)
```

동일 서브넷이 자정 전후로 완전히 다른 결과를 보임.

#### 2. 버스트 차단 (동시 요청 감지)

| IP당 동시요청 | 평균 차단율 |
|--------------|-------------|
| 1~3개 | 0~22% |
| 5개 | 22% |
| 10개 | 73% |
| 20개 | 71% |

**결론**: IP당 동시 요청 3개 이하가 안전

#### 3. 쿠키 활성도의 영향

- 브라우저로 **동시에 활성 사용 중인 쿠키** = 100% 성공
- Akamai가 "실제 사용자 세션"으로 인식하는 것으로 추정
- 쿠키의 "나이"보다 **세션 활성도**가 더 중요

## Rate Limit 메커니즘 (추정)

### 두 가지 레이어

| 레이어 | 기준 | 특징 |
|--------|------|------|
| **일별 한도** | ~150회/IP/일 | 자정 리셋, 다른 사용자와 공유 |
| **버스트 감지** | N회/초 | 동시 요청에 민감, 즉시 차단 |

### 차단 유형

| 차단율 | 원인 |
|--------|------|
| 100% | IP가 영구 블랙리스트 또는 일별 한도 소진 |
| 50~80% | Rate Limit 도달, 간헐적 복구 |
| 0~40% | 정상 IP, 충분한 여유 슬롯 |

## 최적 운영 전략

### 권장 설정

```bash
# 최적 설정
python3 tests/rank_test.py -n 100 -p 3

# 안전 설정 (보수적)
python3 tests/rank_test.py -n 100 -p 1
```

### 시간대별 전략

| 시간대 | 권장 전략 |
|--------|----------|
| 00:00~02:00 | **골든 타임** - 적극적 실행 |
| 02:00~12:00 | 일반 운영 |
| 12:00~18:00 | Rate Limit 누적 주의 |
| 18:00~24:00 | 보수적 운영 (한도 소진 가능) |

### 쿠키 관리

1. **신선한 쿠키 우선**: 생성 60분 이내 쿠키 사용
2. **성공률 기반 선택**: `success_count` 높은 쿠키 우선
3. **브라우저 워밍업**: 가능하면 브라우저로 주기적 활성화

## 향후 테스트 계획

1. **시간대별 차단율 측정**: 1시간 간격으로 24시간 모니터링
2. **리셋 시점 정밀 측정**: 정확히 00:00인지, 다른 시간인지
3. **쿠키 수명 테스트**: 생성 후 N분 경과별 성공률 비교
4. **IP 로테이션 효과**: 같은 서브넷 내 IP 교체 효과

## 파일 변경 이력

- `lib/common/proxy.py`: `last_used_at` → `last_success_at`, `last_fail_at` 분리
- `tests/rank_test.py`: 로그 자동 정리 (30개 유지), IP별 상세 통계
- `coupang.py`: `--exclude-subnets` 옵션 추가
- DB 스키마: `cookies` 테이블 컬럼 변경

---

*작성: 2025-11-26 00:20*
